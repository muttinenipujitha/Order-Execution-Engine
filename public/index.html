<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Execution Engine (Mock Raydium/Meteora)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Order Execution Engine</h1>
        <p class="text-slate-300 mt-1">Market orders • Mock DEX routing (Raydium vs Meteora) • Real-time WebSocket updates</p>
      </div>
      <div class="flex items-center gap-2">
        <span id="healthDot" class="inline-block w-3 h-3 rounded-full bg-slate-600"></span>
        <span id="healthText" class="text-sm text-slate-300">checking…</span>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <section class="lg:col-span-1 rounded-2xl bg-slate-900/60 border border-slate-800 p-5 shadow-lg">
        <h2 class="text-lg font-medium">Submit order</h2>
        <form id="orderForm" class="mt-4 space-y-3">
          <div>
            <label class="text-sm text-slate-300">Token In</label>
            <input id="tokenIn" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" value="SOL" />
          </div>
          <div>
            <label class="text-sm text-slate-300">Token Out</label>
            <input id="tokenOut" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" value="USDC" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300">Amount In</label>
              <input id="amountIn" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" value="0.5" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Slippage (bps)</label>
              <input id="slippageBps" type="number" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" value="50" />
            </div>
          </div>

          <div class="flex gap-2">
            <button class="flex-1 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition px-4 py-2 font-medium" type="submit">
              Execute (Market)
            </button>
            <button id="clearBtn" class="rounded-xl bg-slate-800 hover:bg-slate-700 transition px-4 py-2" type="button">
              Clear
            </button>
          </div>

          <p class="text-xs text-slate-400">
            Tip: submit 3–5 orders quickly to demo concurrency + WS updates.
          </p>
        </form>
      </section>

      <section class="lg:col-span-2 rounded-2xl bg-slate-900/60 border border-slate-800 p-5 shadow-lg">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-medium">Live orders</h2>
          <div class="text-sm text-slate-300">Active: <span id="activeCount" class="font-semibold">0</span></div>
        </div>

        <div id="orders" class="mt-4 grid grid-cols-1 gap-4"></div>
      </section>
    </main>

    <footer class="text-xs text-slate-500 mt-8">
      Status flow: pending → routing → building → submitted → confirmed / failed
    </footer>
  </div>

<script>
const ordersEl = document.getElementById("orders");
const activeCountEl = document.getElementById("activeCount");

function setHealth(ok) {
  document.getElementById("healthDot").className = "inline-block w-3 h-3 rounded-full " + (ok ? "bg-emerald-400" : "bg-rose-400");
  document.getElementById("healthText").textContent = ok ? "API healthy" : "API down";
}

async function checkHealth() {
  try {
    const r = await fetch("/health");
    setHealth(r.ok);
  } catch { setHealth(false); }
}
checkHealth();
setInterval(checkHealth, 4000);

const statusBadge = (s) => {
  const map = {
    pending: "bg-slate-700",
    routing: "bg-blue-600",
    building: "bg-amber-600",
    submitted: "bg-purple-600",
    confirmed: "bg-emerald-600",
    failed: "bg-rose-600",
  };
  return `<span class="text-xs px-2 py-1 rounded-lg ${map[s] || "bg-slate-700"}">${s}</span>`;
};

function createOrderCard(orderId) {
  const wrap = document.createElement("div");
  wrap.className = "rounded-2xl border border-slate-800 bg-slate-950/60 p-4";
  wrap.id = `card_${orderId}`;

  wrap.innerHTML = `
    <div class="flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="text-sm text-slate-300">Order</div>
        <div class="font-mono text-sm truncate">${orderId}</div>
      </div>
      <div id="badge_${orderId}">${statusBadge("pending")}</div>
    </div>
    <div class="mt-3 text-sm text-slate-200">
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-slate-400">DEX:</span>
        <span id="dex_${orderId}" class="font-medium">—</span>
        <span class="text-slate-400 ml-3">Tx:</span>
        <span id="tx_${orderId}" class="font-mono">—</span>
        <span class="text-slate-400 ml-3">Price:</span>
        <span id="price_${orderId}" class="font-medium">—</span>
      </div>
    </div>
    <div class="mt-3">
      <div class="text-xs text-slate-400 mb-2">Events</div>
      <div id="log_${orderId}" class="space-y-2"></div>
      
    </div>
  `;
  ordersEl.prepend(wrap);
  return wrap;
}

function addLog(orderId, msg, data) {
  const log = document.getElementById(`log_${orderId}`);
  if (!log) return;
  const row = document.createElement("div");
  row.className = "rounded-xl border border-slate-800 bg-slate-900/40 p-2";
  row.innerHTML = `
    <div class="flex items-center justify-between gap-2">
      <div class="text-xs text-slate-300">${msg}</div>
      <div class="text-[11px] text-slate-500">${new Date().toLocaleTimeString()}</div>
    </div>
    ${data ? `<pre class="mt-1 text-[11px] text-slate-400 overflow-auto whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>` : ""}
  `;
  log.prepend(row);
}

const sockets = new Map();

function connectWs(orderId) {
  const ws = new WebSocket(`ws://${location.host}/api/orders/execute?orderId=${orderId}`);
  sockets.set(orderId, ws);
  activeCountEl.textContent = sockets.size;

  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    const badge = document.getElementById(`badge_${orderId}`);
    if (badge && msg.status) badge.innerHTML = statusBadge(msg.status);

    if (msg.data?.chosenDex) document.getElementById(`dex_${orderId}`).textContent = msg.data.chosenDex;
    if (msg.data?.txHash) document.getElementById(`tx_${orderId}`).textContent = msg.data.txHash;
    if (msg.data?.executedPrice) document.getElementById(`price_${orderId}`).textContent = msg.data.executedPrice.toFixed(6);

    addLog(orderId, msg.status, msg.data);
  };

  ws.onclose = () => {
    sockets.delete(orderId);
    activeCountEl.textContent = sockets.size;
  };
}

document.getElementById("orderForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const tokenIn = document.getElementById("tokenIn").value.trim();
  const tokenOut = document.getElementById("tokenOut").value.trim();
  const amountIn = Number(document.getElementById("amountIn").value);
  const slippageBps = Number(document.getElementById("slippageBps").value);

  const payload = { orderType: "market", tokenIn, tokenOut, amountIn, slippageBps };
  const res = await fetch("/api/orders/execute", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!res.ok) {
    alert("Error: " + JSON.stringify(data));
    return;
  }

  createOrderCard(data.orderId);
  connectWs(data.orderId);
});

document.getElementById("clearBtn").addEventListener("click", () => {
  ordersEl.innerHTML = "";
  for (const ws of sockets.values()) ws.close();
  sockets.clear();
  activeCountEl.textContent = "0";
});
</script>
</body>
</html>
